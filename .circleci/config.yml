version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.3

jobs:
  build-and-log:
    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      - setup_remote_docker

      # ðŸ” Assume AWS Role using OIDC
      - aws-cli/setup:
          role_arn: ${AWS_ROLE_ARN}
          region: ${AWS_REGION}

      # Install jq (needed for safe JSON conversion)
      - run:
          name: Install jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq

      # ðŸ³ Build Docker (capture logs, allow failure)
      - run:
          name: Build Docker (capture logs)
          command: |
            set +e
            docker build -t test-image . > build.log 2>&1
            EXIT_CODE=$?
            echo $EXIT_CODE > exit_code.txt
            exit 0

      # ðŸ“¤ Push logs to CloudWatch (always runs)
      - run:
          name: Push log to CloudWatch
          command: |
            LOG_GROUP="/circleci/devops-agent-dockerhub-demo"
            LOG_STREAM="circleci-${CIRCLE_BUILD_NUM}"
            TIMESTAMP=$(($(date +%s%N)/1000000))

            aws logs create-log-stream \
              --log-group-name "$LOG_GROUP" \
              --log-stream-name "$LOG_STREAM" || true

            LOG_SNIP=$(tail -n 50 build.log)

            aws logs put-log-events \
              --log-group-name "$LOG_GROUP" \
              --log-stream-name "$LOG_STREAM" \
              --log-events "[{\"timestamp\":$TIMESTAMP,\"message\":$(printf '%s' "$LOG_SNIP" | jq -Rs .)}]"

      # ðŸš¨ Trigger DevOps Agent if failed
      - run:
          name: Trigger DevOps Agent (only on failure)
          command: |
            EXIT_CODE=$(cat exit_code.txt)
            if [ "$EXIT_CODE" -ne 0 ]; then
              echo "Build failed â€” notifying DevOps Agent"

              payload="{\"title\":\"CircleCI failure: ${CIRCLE_PROJECT_REPONAME}\",\"description\":\"Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\nBranch: ${CIRCLE_BRANCH}\nBuild: ${CIRCLE_BUILD_URL}\"}"

              curl -X POST "$AWS_DEVOPS_LAMBDA_URL" \
                -H "Content-Type: application/json" \
                -H "x-circle-secret: $CIRCLE_SHARED_SECRET" \
                -d "$payload"

              exit 1
            fi

workflows:
  simple-workflow:
    jobs:
      - build-and-log
