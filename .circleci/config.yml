version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.3

jobs:
  docker-build-test:
    docker:
      - image: cimg/base:stable

    environment:
      LOG_GROUP: "/circleci/devops-agent-dockerhub-demo"

    steps:
      - checkout
      - setup_remote_docker

      - aws-cli/setup:
          role_arn: ${AWS_ROLE_ARN}
          region: ${AWS_REGION}

      - run:
          name: Install jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq

      # Docker login (normal)
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      # Docker build (natural failure from app.py)
      - run:
          name: Docker Build (capture logs)
          command: |
            set +e
            docker build -t test-image . > build.log 2>&1
            EXIT_CODE=$?
            echo "$EXIT_CODE" > exit_code.txt
            exit 0

      # Push logs to CloudWatch
      - run:
          name: Push logs to CloudWatch
          command: |
            set -euo pipefail

            LOG_STREAM="circleci-${CIRCLE_BUILD_NUM}"
            TIMESTAMP_MS=$(($(date +%s%N)/1000000))

            {
              echo "Build URL: ${CIRCLE_BUILD_URL}"
              echo "Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
              echo "Branch: ${CIRCLE_BRANCH}"
              echo "Commit: ${CIRCLE_SHA1}"
              echo "Exit code: $(cat exit_code.txt)"
              echo "----- build.log tail -----"
              tail -n 200 build.log || true
            } > cw_message.log

            aws logs create-log-group --log-group-name "${LOG_GROUP}" 2>/dev/null || true
            aws logs create-log-stream --log-group-name "${LOG_GROUP}" --log-stream-name "${LOG_STREAM}" 2>/dev/null || true

            MESSAGE_JSON=$(jq -Rs . < cw_message.log)

            TOKEN=$(aws logs describe-log-streams \
              --log-group-name "${LOG_GROUP}" \
              --log-stream-name-prefix "${LOG_STREAM}" \
              --query "logStreams[0].uploadSequenceToken" \
              --output text 2>/dev/null || true)

            if [ "${TOKEN}" = "None" ] || [ -z "${TOKEN}" ]; then
              aws logs put-log-events \
                --log-group-name "${LOG_GROUP}" \
                --log-stream-name "${LOG_STREAM}" \
                --log-events "[{\"timestamp\":${TIMESTAMP_MS},\"message\":${MESSAGE_JSON}}]"
            else
              aws logs put-log-events \
                --log-group-name "${LOG_GROUP}" \
                --log-stream-name "${LOG_STREAM}" \
                --log-events "[{\"timestamp\":${TIMESTAMP_MS},\"message\":${MESSAGE_JSON}}]" \
                --sequence-token "${TOKEN}"
            fi

      # Trigger DevOps Agent if failed (no hints)
      - run:
          name: Notify DevOps Agent (if failed)
          command: |
            set -euo pipefail
            EXIT_CODE=$(cat exit_code.txt)

            if [ "${EXIT_CODE}" -ne 0 ]; then
              LOG_STREAM="circleci-${CIRCLE_BUILD_NUM}"

              payload=$(jq -n \
                --arg title "CircleCI failure: ${CIRCLE_PROJECT_REPONAME}" \
                --arg description "Build failed.\nBuild: ${CIRCLE_BUILD_URL}" \
                --arg aws_region "${AWS_REGION}" \
                --arg log_group "${LOG_GROUP}" \
                --arg log_stream "${LOG_STREAM}" \
                '{
                  title: $title,
                  description: $description,
                  aws_region: $aws_region,
                  cloudwatch: {
                    log_group: $log_group,
                    log_stream: $log_stream
                  }
                }')

              curl -sS -X POST "${AWS_DEVOPS_LAMBDA_URL}" \
                -H "Content-Type: application/json" \
                -H "x-circle-secret: ${CIRCLE_SHARED_SECRET}" \
                -d "${payload}"

              exit 1
            fi

workflows:
  docker-build-workflow:
    jobs:
      - docker-build-test