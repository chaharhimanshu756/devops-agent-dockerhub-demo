version: 2.1

jobs:
  build-and-push:
    docker:
      - image: cimg/base:stable

    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - run:
          name: Build Docker Image (capture logs)
          command: |
            set +e
            docker build -t ${DOCKERHUB_USERNAME}/devops-agent-demo:latest . > build.log 2>&1
            EXIT_CODE=$?
            echo $EXIT_CODE > exit_code.txt
            exit 0

      - run:
          name: Fail job if docker failed
          command: |
            EXIT_CODE=$(cat exit_code.txt)
            if [ "$EXIT_CODE" -ne 0 ]; then
              echo "Build failed"
              exit 1
            fi

      - run:
          name: Notify DevOps Agent (only on failure)
          when: on_fail
          command: |
            echo "Sending logs to DevOps Agent..."

            LOG_SNIP=$(tail -n 150 build.log | \
              sed -e 's/\\/\\\\/g' \
                  -e 's/"/\\"/g' \
                  -e ':a;N;$!ba;s/\n/\\n/g')

            DESC="Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\\nBranch: ${CIRCLE_BRANCH}\\nBuild: ${CIRCLE_BUILD_URL}\\n\\nError Logs (last 150 lines):\\n${LOG_SNIP}"

            payload="{\"title\":\"CircleCI failure: ${CIRCLE_PROJECT_REPONAME}\",\"description\":\"${DESC}\"}"

            curl -sS -X POST "$AWS_DEVOPS_LAMBDA_URL" \
              -H "Content-Type: application/json" \
              -H "x-circle-secret: $CIRCLE_SHARED_SECRET" \
              -d "$payload"

workflows:
  build-workflow:
    jobs:
      - build-and-push
