version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1

jobs:
  build-and-send:
    docker:
      - image: cimg/base:stable
    environment:
      LOG_GROUP: /circleci/devops-agent-dockerhub-demo
      LOG_FILE: /tmp/build.log
    steps:
      - checkout

      # Auth to AWS via role (use your preferred method; this orb supports role_arn)
      - aws-cli/setup:
          region: AWS_REGION
          role_arn: AWS_ROLE_ARN

      - run:
          name: Start CloudWatch log shipper
          command: |
            set -e
            export LOG_STREAM="circleci/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_WORKFLOW_ID}/${CIRCLE_JOB}/${CIRCLE_BUILD_NUM}"
            echo "LOG_STREAM=${LOG_STREAM}"
            python3 -m pip install --user boto3
            # start shipper in background
            (python3 .circleci/cw_shipper.py &) 
            echo $! > /tmp/cw_shipper.pid

      - run:
          name: Build (tee output to file for shipping)
          command: |
            set -euo pipefail
            # Example build command; replace with yours
            ./your_build_command 2>&1 | tee -a "${LOG_FILE}"

      - run:
          name: Stop shipper + Invoke Lambda with log metadata
          when: always
          command: |
            set -e
            export LOG_STREAM="circleci/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_WORKFLOW_ID}/${CIRCLE_JOB}/${CIRCLE_BUILD_NUM}"

            # tell shipper to stop cleanly
            echo "__CW_SHIPPER_STOP__" >> "${LOG_FILE}"
            sleep 2

            # invoke Lambda (your endpoint). Include status & metadata.
            STATUS="success"
            if [ "${CIRCLE_JOB}" = "" ]; then STATUS="unknown"; fi

            PAYLOAD=$(cat <<EOF
            {
              "logGroup": "${LOG_GROUP}",
              "logStream": "${LOG_STREAM}",
              "buildNum": "${CIRCLE_BUILD_NUM}",
              "workflowId": "${CIRCLE_WORKFLOW_ID}",
              "job": "${CIRCLE_JOB}",
              "repo": "${CIRCLE_PROJECT_REPONAME}",
              "branch": "${CIRCLE_BRANCH}",
              "sha1": "${CIRCLE_SHA1}",
              "status": "${STATUS}"
            }
EOF
            )

            echo "Invoking Lambda with payload:"
            echo "${PAYLOAD}"

            curl -sS -X POST "${AWS_DEVOPS_LAMBDA_URL}" \
              -H "Content-Type: application/json" \
              -H "x-circleci-signature: ${CIRCLE_SHARED_SECRET}" \
              -d "${PAYLOAD}"
