version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.3

jobs:
  build-and-log:
    docker:
      - image: cimg/base:stable

    environment:
      LOG_GROUP: "/circleci/devops-agent-dockerhub-demo"

    steps:
      - checkout

      - setup_remote_docker

      - aws-cli/setup:
          role_arn: ${AWS_ROLE_ARN}
          region: ${AWS_REGION}

      - run:
          name: Install jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq

      - run:
          name: Build Docker (capture logs)
          command: |
            set +e
            docker build -t test-image . > build.log 2>&1
            EXIT_CODE=$?
            echo "$EXIT_CODE" > exit_code.txt
            exit 0

      - run:
          name: Push logs to CloudWatch
          command: |
            set -euo pipefail

            LOG_STREAM="circleci-${CIRCLE_BUILD_NUM}"
            TIMESTAMP_MS=$(($(date +%s%N)/1000000))

            {
              echo "Build URL: ${CIRCLE_BUILD_URL}"
              echo "Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
              echo "Branch: ${CIRCLE_BRANCH}"
              echo "Build Num: ${CIRCLE_BUILD_NUM}"
              echo "Commit: ${CIRCLE_SHA1}"
              echo "Exit code: $(cat exit_code.txt)"
              echo "----- tail(200) of build.log -----"
              tail -n 200 build.log || true
            } > cw_message.log

            aws logs create-log-group --log-group-name "${LOG_GROUP}" 2>/dev/null || true

            aws logs create-log-stream \
              --log-group-name "${LOG_GROUP}" \
              --log-stream-name "${LOG_STREAM}" 2>/dev/null || true

            MESSAGE_JSON=$(jq -Rs . < cw_message.log)

            TOKEN=$(aws logs describe-log-streams \
              --log-group-name "${LOG_GROUP}" \
              --log-stream-name-prefix "${LOG_STREAM}" \
              --query "logStreams[0].uploadSequenceToken" \
              --output text 2>/dev/null || true)

            if [ "${TOKEN}" = "None" ] || [ -z "${TOKEN}" ]; then
              aws logs put-log-events \
                --log-group-name "${LOG_GROUP}" \
                --log-stream-name "${LOG_STREAM}" \
                --log-events "[{\"timestamp\":${TIMESTAMP_MS},\"message\":${MESSAGE_JSON}}]"
            else
              aws logs put-log-events \
                --log-group-name "${LOG_GROUP}" \
                --log-stream-name "${LOG_STREAM}" \
                --log-events "[{\"timestamp\":${TIMESTAMP_MS},\"message\":${MESSAGE_JSON}}]" \
                --sequence-token "${TOKEN}"
            fi

      - run:
          name: Trigger DevOps Agent (only on failure)
          command: |
            set -euo pipefail
            EXIT_CODE=$(cat exit_code.txt)

            if [ "${EXIT_CODE}" -ne 0 ]; then
              echo "Build failed â€” notifying DevOps Agent"

              LOG_STREAM="circleci-${CIRCLE_BUILD_NUM}"

              payload="$(cat <<EOF
{
  "title": "CircleCI failure: ${CIRCLE_PROJECT_REPONAME}",
  "description": "Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\nBranch: ${CIRCLE_BRANCH}\nBuild: ${CIRCLE_BUILD_URL}\nCommit: ${CIRCLE_SHA1}\nExitCode: ${EXIT_CODE}",
  "build_num": ${CIRCLE_BUILD_NUM},
  "aws_region": "${AWS_REGION}",
  "cloudwatch": {
    "log_group": "${LOG_GROUP}",
    "log_stream": "${LOG_STREAM}"
  }
}
EOF
)"

              curl -sS -X POST "${AWS_DEVOPS_LAMBDA_URL}" \
                -H "Content-Type: application/json" \
                -H "x-circle-secret: ${CIRCLE_SHARED_SECRET}" \
                -d "${payload}"

              exit 1
            fi

workflows:
  simple-workflow:
    jobs:
      - build-and-log