version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.3

jobs:
  build-and-log:
    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      # Required to run docker build
      - setup_remote_docker

      # Run docker build (this will fail)
      - run:
          name: Build Docker Image (Intentional Failure)
          command: |
            docker build -t test-image .

      # Assume role using OIDC
      - aws-cli/setup:
          role_arn: ${AWS_ROLE_ARN}
          region: ${AWS_REGION}

      - run:
          name: Send test log to CloudWatch
          when: on_fail
          command: |
            LOG_GROUP="/circleci/devops-agent-dockerhub-demo"
            LOG_STREAM="circleci-${CIRCLE_BUILD_NUM}"
            TIMESTAMP=$(($(date +%s%N)/1000000))

            aws logs create-log-stream \
              --log-group-name "$LOG_GROUP" \
              --log-stream-name "$LOG_STREAM" || true

            aws logs put-log-events \
              --log-group-name "$LOG_GROUP" \
              --log-stream-name "$LOG_STREAM" \
              --log-events timestamp=$TIMESTAMP,message="Docker build failed in ${CIRCLE_BUILD_URL}"

workflows:
  simple-workflow:
    jobs:
      - build-and-log
