version: 2.1

jobs:
  build-and-push:
    docker:
      - image: cimg/base:stable

    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: Docker login
          command: |
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - run:
          name: Build + Push (and notify on failure)
          command: |
            set +e

            IMAGE="$DOCKERHUB_USERNAME/devops-agent-demo:latest"

            echo "Building image: $IMAGE"
            docker build -t "$IMAGE" .
            BUILD_EXIT=$?

            if [ $BUILD_EXIT -eq 0 ]; then
              echo "Pushing image: $IMAGE"
              docker push "$IMAGE"
              PUSH_EXIT=$?
            else
              PUSH_EXIT=0
            fi

            FAIL=$((BUILD_EXIT != 0 || PUSH_EXIT != 0))

            if [ $FAIL -ne 0 ]; then
              echo "‚ùå Build/Push failed, notifying DevOps Agent adapter Lambda..."

              payload=$(cat <<JSON
{
  "title": "CircleCI failure: ${CIRCLE_PROJECT_REPONAME}",
  "description": "Job failed. Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME} | Branch: ${CIRCLE_BRANCH} | Build: ${CIRCLE_BUILD_URL}",
  "build_url": "${CIRCLE_BUILD_URL}",
  "repo": "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}",
  "branch": "${CIRCLE_BRANCH}"
}
JSON
)

              curl -sS -X POST "$AWS_DEVOPS_LAMBDA_URL" \
                -H "Content-Type: application/json" \
                -H "x-circle-secret: $CIRCLE_SHARED_SECRET" \
                -d "$payload"
            fi

            # Make job status correct
            if [ $BUILD_EXIT -ne 0 ]; then exit $BUILD_EXIT; fi
            if [ $PUSH_EXIT -ne 0 ]; then exit $PUSH_EXIT; fi
            exit 0

workflows:
  build-workflow:
    jobs:
      - build-and-push
