version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1

jobs:
  build-and-devops-agent:
    docker:
      - image: cimg/python:3.11

    environment:
      LOG_GROUP: /circleci/devops-agent-dockerhub-demo
      LOG_FILE: /tmp/build.log

    steps:
      - checkout

      - aws-cli/setup:
          region: AWS_REGION
          role_arn: AWS_ROLE_ARN

      - run:
          name: Install jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq

      - run:
          name: Start CloudWatch log streaming
          command: |
            set -e
            touch "${LOG_FILE}"
            export LOG_STREAM="circleci/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_WORKFLOW_ID}/${CIRCLE_JOB}/${CIRCLE_BUILD_NUM}"
            python -c "import boto3" || pip install --user boto3
            python .circleci/cw_shipper.py &
            echo $! > /tmp/cw_shipper.pid

      - run:
          name: Build (capture status)
          command: |
            set +e
            ./build.sh 2>&1 | tee -a "${LOG_FILE}"
            echo $? > /tmp/build_exit_code
            exit 0

      - run:
          name: Stop shipper + invoke Lambda (always)
          when: always
          command: |
            set +e
            export LOG_STREAM="circleci/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_WORKFLOW_ID}/${CIRCLE_JOB}/${CIRCLE_BUILD_NUM}"

            # stop shipper cleanly
            echo "__CW_STOP__" >> "${LOG_FILE}"
            sleep 2

            EXIT_CODE=$(cat /tmp/build_exit_code 2>/dev/null || echo 1)
            if [ "$EXIT_CODE" = "0" ]; then STATUS="success"; else STATUS="failed"; fi

            PAYLOAD=$(jq -n \
              --arg logGroup "${LOG_GROUP}" \
              --arg logStream "${LOG_STREAM}" \
              --arg buildNum "${CIRCLE_BUILD_NUM}" \
              --arg workflowId "${CIRCLE_WORKFLOW_ID}" \
              --arg job "${CIRCLE_JOB}" \
              --arg repo "${CIRCLE_PROJECT_REPONAME}" \
              --arg branch "${CIRCLE_BRANCH}" \
              --arg sha1 "${CIRCLE_SHA1}" \
              --arg status "${STATUS}" \
              '{
                logGroup: $logGroup,
                logStream: $logStream,
                buildNum: $buildNum,
                workflowId: $workflowId,
                job: $job,
                repo: $repo,
                branch: $branch,
                sha1: $sha1,
                status: $status
              }')

            curl -sS -X POST "${AWS_DEVOPS_LAMBDA_URL}" \
              -H "Content-Type: application/json" \
              -H "x-circleci-signature: ${CIRCLE_SHARED_SECRET}" \
              -d "${PAYLOAD}" || true

workflows:
  version: 2
  devops-agent-dockerhub-demo:
    jobs:
      - build-and-devops-agent
