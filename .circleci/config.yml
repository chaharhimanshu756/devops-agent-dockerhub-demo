version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1

jobs:
  build-and-devops-agent:
    docker:
      - image: cimg/base:stable

    environment:
      LOG_GROUP: /circleci/devops-agent-dockerhub-demo

    steps:
      - checkout

      # If earlier it worked, keep your existing role+region flow
      - aws-cli/setup:
          region: AWS_REGION
          role_arn: AWS_ROLE_ARN

      - run:
          name: Build (prints CloudWatch markers)
          command: |
            set -euo pipefail

            # These lines MUST appear in CloudWatch logs (your existing log shipping will carry them)
            echo "CW_MARKER_START build=${CIRCLE_BUILD_NUM} workflow=${CIRCLE_WORKFLOW_ID} job=${CIRCLE_JOB} repo=${CIRCLE_PROJECT_REPONAME} sha=${CIRCLE_SHA1}"
            
            # YOUR REAL BUILD COMMAND(S)
            ./build.sh

            echo "CW_MARKER_END build=${CIRCLE_BUILD_NUM} workflow=${CIRCLE_WORKFLOW_ID} job=${CIRCLE_JOB} status=success"

      - run:
          name: Invoke Lambda (end) with identifiers
          when: always
          command: |
            set +e

            # If build failed earlier, this step still runs. Tell Lambda "unknown" unless you compute it.
            STATUS="unknown"

            # Minimal JSON payload without jq/heredoc (safe)
            PAYLOAD="{\"logGroup\":\"${LOG_GROUP}\",\"buildNum\":\"${CIRCLE_BUILD_NUM}\",\"workflowId\":\"${CIRCLE_WORKFLOW_ID}\",\"job\":\"${CIRCLE_JOB}\",\"repo\":\"${CIRCLE_PROJECT_REPONAME}\",\"branch\":\"${CIRCLE_BRANCH}\",\"sha1\":\"${CIRCLE_SHA1}\",\"status\":\"${STATUS}\"}"

            curl -sS -X POST "${AWS_DEVOPS_LAMBDA_URL}" \
              -H "Content-Type: application/json" \
              -H "x-circleci-signature: ${CIRCLE_SHARED_SECRET}" \
              -d "${PAYLOAD}" || true

workflows:
  version: 2
  devops-agent-dockerhub-demo:
    jobs:
      - build-and-devops-agent
